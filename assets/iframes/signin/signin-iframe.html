<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
	<link href="../css/style.css" rel="stylesheet">
	<link href="../css/responsive.css" rel="stylesheet">

</head>

<body>	
	<section id="form">
		<div class="container">
			<div class="row">
				<div class="col-sm-4 col-sm-offset-1">
					<div class="login-form">
						<h2>Sign In to Your Account</h2>
						
						<form id = "sign_in">
							<input type="email" id="sign_up_email" name="email" placeholder="Email Address"/>
							<input type="password" id="sign_up_pwd" name="password" placeholder="Password"/>
							<span>
								<input type="checkbox" class="checkbox" id="showpass">
								<label for="showpass">Show Password</label> 
							</span>
							<span style="float: right;">
								<a href="">Forgot Password</a>
							</span>
							<button type="submit" class="btn btn-default">Sign In</button>
						</form>

					</div>
				</div>
				<div class="col-sm-1">
					<h2 class="or">OR</h2>
				</div>
				<div class="col-sm-4">
					<div class="signup-form">
						<h2>New User Sign Up!</h2>
						
						<form id = "sign_up" action="http://localhost:8080/registerUserAsBuyer" method="POST">
							<input type="text" id="sign_in_username" name="username" placeholder="Username"/>
							<input type="email" id="sign_up_email" name="email" placeholder="Email Address"/>
							<input type="password" id="sign_up_pwd" name="password" placeholder="Password"/>
							
							<button type="submit" class="btn btn-default">Sign Up</button>
						</form>

					</div>
				</div>
			</div>
		</div>
	</section>
	
	<script>
		// JS code related to Sign Up
		const signUpForm = document.getElementById("sign_up");
		
		signUpForm.addEventListener("submit", function(e){
			e.preventDefault();
			
			let usernameValid = validateUsername();
			usernameValid.then(value => {
				if(value == "No"){
					alert("Please enter a username!");
				}else if(value == "Have"){
					alert("Username already exists!");
				}else{
					let emailValid = validateEmail();
					
					emailValid.then(value => {
						if(value == "No"){
							alert("Please enter an email!");
						}else if(value == "Have"){
							alert("You have already registered with this email address! Please sign in to your account.");
						}else if(checkPasswordStrength() == false){
							alert("Password must have at least one lowercase letter, one uppercase letter, one digit, one special character, and is at least eight characters long.");
						}else{
							registerNewUser();
						}
					}).catch(err => {
						console.log(err);
					});
				}
			}).catch(err => {
				console.log(err);
			});
			
		})

		
		const validateUsername = async() => {
			const data = new FormData(signUpForm);
			const usernameVar = data.get("username");
			
			if(usernameVar == ""){
				return "No";
			}else{
				let response = await fetch("http://localhost:8080/getAllUsernames");
				let usernames = await response.json();
				
				
				for (let i = 0; i < usernames.length; i++) {
					if(usernameVar == usernames[i].username){
						return "Have";
						break;
					}
				}
			}
		}


		const validateEmail = async() => {
			const data = new FormData(signUpForm);
			const emailVar = data.get("email");
			
			if(emailVar == ""){
				return "No";
			}else{
				let response = await fetch("http://localhost:8080/getAllUserEmails");
				let emails = await response.json();
				
				
				for (let i = 0; i < emails.length; i++) {
					if(emailVar == emails[i].email){
						return "Have";
						break;
					}
				}
			}
		}
		

		function checkPasswordStrength(){
			const data = new FormData(signUpForm);
			const pwdVar = data.get("password");

			// Password must have at least one lowercase letter (?=.*[a-z]), 
			// one uppercase letter (?=.*[A-Z]), 
			// one digit (?=.*[0-9]), 
			// one special character (?=.*[^A-Za-z0-9]), 
			// and is at least eight characters long(?=.{8,}).
			let pwdCriteria = new RegExp('(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[^A-Za-z0-9])(?=.{8,})');
			if(pwdCriteria.test(pwdVar)) {
				return true;
			}else{
				return false;
			}
		}

		
		const registerNewUser = async() => {
			const data = new FormData(signUpForm);

			const usernameVar = data.get("username");
			const emailVar = data.get("email");
			const pwdVar = data.get("password");

			let response = await fetch("http://localhost:8080/noOfUsers");
			let noOfUsers = await response.json();

			var object = {};
			object["id"] = noOfUsers + 1;
			object["username"] = usernameVar;
			object["email"] = emailVar;
			object["password"] = pwdVar;
			object["accountType"] = "Buyer";
			object["contactNo"] = "NA";
			object["deliveryAddress"] = "NA";
			object["storeName"] = "NA";
			object["storeAddress"] = "NA";
			object["paymentAccountName"] = "NA";
			object["paymentAccountNo"] = "NA";
			object["paymentAccountBankName"] = "NA";
			object["paymentAccountBankBranchName"] = "NA";

			
			var jsonText = JSON.stringify(object);
			
			await fetch("http://localhost:8080/registerUserAsBuyer", {
				method: "POST",
				headers: {
					'Accept': 'application/json',
					'Content-Type': 'application/json'
				},
				body: jsonText
			})
			.then(response => response.text())
			.then(alert("Registration Successful! Please Sign In to your account to continue!"))
			.catch(error => console.log('Authorization failed: ' + error.message));	

		}

		
		// JS code related to Sign In
		const signInForm = document.getElementById("sign_in");
		
		signInForm.addEventListener("submit", function(e){
			e.preventDefault();
			signInUser();
		})

		const signInUser = async() => {
			const data = new FormData(signInForm);
			const emailVar = data.get("email");
			const pwdVar = data.get("password");

			let response1 = await fetch("http://localhost:8080/getAllUserEmails");
			let emails = await response1.json();

			let response2 = await fetch("http://localhost:8080/getAllUserPasswords");
			let passwords = await response2.json();

			var emailValid = false;
			var index = 0;

			for (let i = 0; i < emails.length; i++) {
				
				if(emailVar == emails[i].email){
					emailValid = true;
					index = i;
					break;	
				}
			}
			

			if(emailValid == true){
				if(pwdVar == passwords[index].password){
					alert("Login Success!");
					open("../../../buyer-dashboard.html", "_parent")
				}else{
					alert("Invalid username or password!");
				}
			}else{
				alert("Invalid username or password!");
			}


		}


	</script>

	<script src="../js/script.js"></script>

</body>
</html>