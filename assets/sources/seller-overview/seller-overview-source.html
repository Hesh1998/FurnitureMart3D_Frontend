<!DOCTYPE html>
<html lang="en">

<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <link href="bootstrap.css" rel="stylesheet" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
        <link href="main-style.css" rel="stylesheet" />
        <link href="../buyer-dashboard/buyer-dashboard-style.css" rel="stylesheet">
    </head>

    <body>
        <div id="analyticsLastMonth"> </div>


        <div id="pieCharts" style="margin-top: 120px;"> </div>


        <div id="barChart" style="margin-top: 120px;"> </div>


        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

        <script>
            // Seller id
		    var sellerId = localStorage.getItem("id");
            var itemNamesFinal = [];
            var itemTotalUnitsSoldFinal = [];
            var itemTotalSalesFinal = [];


            // Download pie chart report
            const downloadPieReport = async() => {

            }


            // Set pie chart information
            const setPieCharts = async() => {
                var dateFrom = document.getElementById("fromPie").value;
                var dateFromD = new Date(dateFrom);

                var dateTo = document.getElementById("toPie").value;
                var dateToD = new Date(dateTo);

                let response4 = await fetch(`http://localhost:8080/findUserProducts/${sellerId}`);
			    let items4 = await response4.json();

                var itemIds = [];
                itemIds.length = items4.length;

                var itemNames = [];
                itemNames.length = items4.length;   

                var itemTotalUnitsSold = [];
                itemTotalUnitsSold.length = items4.length; 

                var itemTotalSales = [];
                itemTotalSales.length = items4.length; 
                
                for (let i = 0; i < items4.length; i++) {
                    itemIds[i] = items4[i].itemId;
                    itemNames[i] = items4[i].itemName;
                    itemTotalUnitsSold[i] = 0;
                    itemTotalSales[i] = 0;
                }


                let response5 = await fetch(`http://localhost:8080/findAllOrderDetails`);
			    let orders5 = await response5.json();

                for(let i=0; i < orders5.length; i++){
                    var dateOrder = new Date(orders5[i].orderDate);

                    if(orders5[i].sellerId == sellerId && (orders5[i].deliveryStatus == "Delivered" || orders5[i].deliveryStatus == "Completed") && (dateOrder <= dateToD && dateOrder >= dateFromD)){
                        for(let j = 0; j < itemIds.length; j++){
                            if(orders5[i].itemId == itemIds[j]){
                                itemTotalUnitsSold[j] += orders5[i].orderQuantity;
                                itemTotalSales[j] += orders5[i].subTotal;
                                break;
                            }
                        }
                    }
                }

                
                // Load google charts
                google.charts.load('current', {'packages':['corechart']});
                google.charts.setOnLoadCallback(drawChart);

                var arrUnitsSold = [];
                arrUnitsSold.length = itemIds.length + 1;
                arrUnitsSold[0] = ['Item', 'Total Units Sold'];

                var arrSales = []
                arrSales.length = itemIds.length + 1;
                arrSales[0] = ['Item', 'Total Sales'];

                for(let i= 0; i < itemIds.length; i++){
                    arrUnitsSold[i+1] = [itemNames[i], itemTotalUnitsSold[i]];
                    arrSales[i+1] = [itemNames[i], itemTotalSales[i]];
                }


                // Draw pie charts
                function drawChart() {
                    var dataUnitsSold = google.visualization.arrayToDataTable(arrUnitsSold);
                    var dataSales = google.visualization.arrayToDataTable(arrSales);

                    var options = {'width':470, 'height':400, 'fontSize': 13, legend: {'position': 'right','alignment':'start'}};

                    var chartUnitsSold = new google.visualization.PieChart(document.getElementById('totalUnitsSoldPie'));
                    var chartSales = new google.visualization.PieChart(document.getElementById('totalSalesPie'));
                    
                    chartUnitsSold.draw(dataUnitsSold, options);
                    chartSales.draw(dataSales, options);
                }


                // Assign values to global arrays - to print report
                itemNamesFinal = [];
                itemNamesFinal = itemNames;

                itemTotalUnitsSoldFinal = [];
                itemTotalUnitsSoldFinal = itemTotalUnitsSold;

                itemTotalSalesFinal = [];
                itemTotalSalesFinal = itemTotalSales;
            }
            

            // Download complete sales report
            const downloadSalesReport = async() => {
                var duration = document.getElementById("analyticsReportChoice").value;

                var totalUnitsSold = 0;
                var totalSales = 0;

                let response3 = await fetch(`http://localhost:8080/findAllOrderDetails`);
			    let orders3 = await response3.json();

                const dateToday = new Date();

                var dateLast = new Date();

                if(duration == "Last Month"){
                    dateLast.setTime(dateLast.getTime() - (30 * 24 * 60 * 60 * 1000));
                }else if(duration == "Last 3 Months"){
                    dateLast.setTime(dateLast.getTime() - (3 * 30 * 24 * 60 * 60 * 1000));
                }else if(duration == "Last 6 Months"){
                    dateLast.setTime(dateLast.getTime() - (6 * 30 * 24 * 60 * 60 * 1000));
                }else if(duration == "Last Year"){
                    dateLast.setTime(dateLast.getTime() - (365 * 24 * 60 * 60 * 1000));
                }else if(duration == "From the Beginning"){
                    dateLast = new Date("1/1/2023");
                }
                
                var salesReport = `<div style="font-family: Open Sans, sans-serif; color: #444444; margin-left: 20px; margin-right: 20px;">
                                    <center>
                                        <hr style="background-color: #444444;">
                                        <h2 style="color: #4CA48C">FurnitureMart 3D - Sales Report (${duration})</h2>
                                        <hr style="background-color: #444444;">
                                        <br>
                                    </center>

                                    <br>

                                    <center>
                                        <table style="border-collapse: collapse; width: 95%;">
                                            <tr>
                                                <th style="border: 1px solid #444444; text-align: left; padding: 8px;">Order Date</th>
                                                <th style="border: 1px solid #444444; text-align: left; padding: 8px;">Item</th>
                                                <th style="border: 1px solid #444444; text-align: left; padding: 8px;">Quantity</th>
                                                <th style="border: 1px solid #444444; text-align: left; padding: 8px;">Payment</th>
                                            </tr>`;

                for(let i=0; i < orders3.length; i++){
                    var dateOrder = new Date(orders3[i].orderDate);

                    if(orders3[i].sellerId == sellerId && (orders3[i].deliveryStatus == "Delivered" || orders3[i].deliveryStatus == "Completed") && (dateOrder <= dateToday && dateOrder >= dateLast)){
                        totalUnitsSold += orders3[i].orderQuantity;
                        totalSales += orders3[i].subTotal;

                        salesReport += `<tr>
                                            <td style="border: 1px solid #444444; text-align: left; padding: 8px; vertical-align: top;">${orders3[i].orderDate}</td>
                                            <td style="border: 1px solid #444444; text-align: left; padding: 8px; vertical-align: top;">
                                                ${orders3[i].itemName} (Colour code : ${orders3[i].clr})
                                                
                                                <br><br>
                                                <img src="${orders3[i].itemImg}" width="150px" height="100px">
                                                <br>
                                            </td>
                                            <td style="border: 1px solid #444444; text-align: left; padding: 8px; vertical-align: top;">${orders3[i].orderQuantity}</td>
                                            <td style="border: 1px solid #444444; text-align: left; padding: 8px; vertical-align: top;">LKR ${(orders3[i].subTotal).toLocaleString('en-US')}</td>
                                        </tr>`;
                    }
                }

                salesReport += `    </table> </center> <br><br>
                                    <center>
                                        <hr style="background-color: #444444;">
                                        <div>
                                            <br>
                                            <h1>Total Number of Units Sold : ${totalUnitsSold}</h1><br>
                                            <h1>Total Sales : LKR ${totalSales.toLocaleString('en-US')}</h1>
                                            <br>
                                        </div>
                                        <hr style="background-color: #444444;">
                                    </center>
                                </div>`;
                
                
                // Print sales report
				const element = salesReport;

                var opt = {
                    filename: 'Sales Report.pdf',
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] },
                    jsPDF: {unit: 'pt', format: 'letter', orientation: 'portrait'}
                };

                html2pdf().from(element).set(opt).save();
            }


            // Set analytics from last month if available
            const setAnalyticsFromLastMonth = async() => {
                var totalUnitsSold = 0;
                var totalSales = 0;

                let response2 = await fetch(`http://localhost:8080/findAllOrderDetails`);
			    let orders2 = await response2.json();

                const dateToday = new Date();

                const dateLastMonth = new Date();
                dateLastMonth.setTime(dateLastMonth.getTime() - (30 * 24 * 60 * 60 * 1000));

                for(let i=0; i < orders2.length; i++){
                    var dateOrder = new Date(orders2[i].orderDate);

                    if(orders2[i].sellerId == sellerId && (orders2[i].deliveryStatus == "Delivered" || orders2[i].deliveryStatus == "Completed") && (dateOrder <= dateToday && dateOrder >= dateLastMonth)){
                        totalUnitsSold += orders2[i].orderQuantity;
                        totalSales += orders2[i].subTotal;
                    }
                }

                document.getElementById("analyticsLastMonth").style.marginTop = "150px";
                document.getElementById("analyticsLastMonth").innerHTML = `<div class="container">
                                                                                <div class="card">
                                                                                    <div class="card-header">
                                                                                        <h1 style="text-align: center;">Analytics from Last Month</h1>
                                                                                    </div>
                                                                                    
                                                                                    <div class="card-body">
                                                                                        <center>
                                                                                            <div class="panel panel-primary text-center" style="width: 45%; border-color: #333333; margin-top: 20px; display: inline-block;">
                                                                                                <div class="panel-body green">
                                                                                                    <img src="product-128.png">
                                                                                                    <h1 style="font-size: 400%;">${totalUnitsSold}</h1>
                                                                                                </div>
                                                                                                <div class="panel-footer">
                                                                                                    <span class="panel-eyecandy-title" style="font-size: 17px;">Total Units Sold from all Products - Last Month <br> (${dateLastMonth.toLocaleDateString('en-CA')} to ${dateToday.toLocaleDateString('en-CA')})</span>
                                                                                                </div>
                                                                                            </div>
                                                                                    
                                                                                            <div class="panel panel-primary text-center" style="width: 45%; border-color: #333333; margin-top: 20px; margin-left: 20px; display: inline-block;">
                                                                                                <div class="panel-body green">
                                                                                                    <img src="sell-128.png">
                                                                                                    <h1 style="font-size: 400%;">LKR ${totalSales.toLocaleString('en-US')}</h1>
                                                                                                </div>
                                                                                                <div class="panel-footer">
                                                                                                    <span class="panel-eyecandy-title" style="font-size: 17px;">Total Sales from all Products - Last Month <br> (${dateLastMonth.toLocaleDateString('en-CA')} to ${dateToday.toLocaleDateString('en-CA')})</span>
                                                                                                </div>
                                                                                            </div>
                                                                                        </center>
                                                                                    </div> 
                                                                    
                                                                                    <div class="card-footer">
                                                                                        <div class="mt-5 text-right">
                                                                                            <select id="analyticsReportChoice" style="color: #333333; font-size: 20px;">
                                                                                                <option value="Last Month">Last Month</option>
                                                                                                <option value="Last 3 Months">Last 3 Months</option>
                                                                                                <option value="Last 6 Months">Last 6 Months</option>
                                                                                                <option value="Last Year">Last Year</option>
                                                                                                <option value="From the Beginning">From the Beginning</option>
                                                                                            </select>
                                                                                            <br><br>

                                                                                            <button class="btn btn-primary profile-button" type="button" style="font-size: large;" onclick="downloadSalesReport()">Download Sales Report</button>
                                                                                        </div>
                                                                                        <br>
                                                                                    </div>
                                                                                </div>
                                                                            </div>`;
            }


            // Setting page details
            const setPageDetails = async() => {
                // Get the number of Completed/Delivered orders by the seller
                let response1 = await fetch(`http://localhost:8080/findAllOrderDetails`);
			    let orders1 = await response1.json();
                var noOfOrders = 0;

                for(let i=0; i < orders1.length; i++){
                    if(orders1[i].sellerId == sellerId && (orders1[i].deliveryStatus == "Delivered" || orders1[i].deliveryStatus == "Completed")){
                        noOfOrders++;
                    }
                }

                if(noOfOrders == 0){
                    document.getElementById("analyticsLastMonth").style.marginTop = "22%";
                    document.getElementById("analyticsLastMonth").innerHTML = `<div class="container">
                                                                                    <div class="card">
                                                                                        <div class="card-header">
                                                                                            <br>
                                                                                            <h1 style="text-align: center;">No Analytics Information to Display Yet!</h1>
                                                                                            <br>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>`;
                }else{
                    // Set last month analytics
                    setAnalyticsFromLastMonth();

                    // Set pie charts
                    document.getElementById("pieCharts").innerHTML = `<div class="container">
                                                                            <div class="card">
                                                                                <div class="card-header">
                                                                                    <h1 style="text-align: center;">Analysis - Each Product</h1>
                                                                                    <br>
                                                                                    <div style="text-align: center;">
                                                                                        <span style="font-size: 15px;">
                                                                                            <span><b>Duration : </b></span> 
                                                                                            <input type="date" id="fromPie" onKeyDown="return false" onchange="setPieCharts()">
                                                                                            <span><b> to </b></span> 
                                                                                            <input type="date" id="toPie" onKeyDown="return false" onchange="setPieCharts()">
                                                                                        </span>
                                                                                    </div>
                                                                                </div>
                                                                                
                                                                                <div class="card-body">
                                                                                    <center>
                                                                                        <div class="panel panel-primary" style=" border-color: #333333; margin-top: 20px; width: 45%; display: inline-block;">
                                                                                            <div class="panel-heading" style="background-color: #4CA48C;">
                                                                                                <h2>Total Units Sold - Each Product</h2>
                                                                                            </div>
                                                                                            <div class="panel-body">
                                                                                                <div id="totalUnitsSoldPie"></div>
                                                                                            </div>
                                                                                        </div>

                                                                                        <div class="panel panel-primary" style=" border-color: #333333; margin-top: 20px; margin-left: 20px; width: 45%; display: inline-block;">
                                                                                            <div class="panel-heading" style="background-color: #4CA48C;">
                                                                                                <h2>Total Sales (LKR) - Each Product</h2>
                                                                                            </div>
                                                                                            <div class="panel-body">
                                                                                                <div id="totalSalesPie"></div>
                                                                                            </div>
                                                                                        </div>
                                                                                    </center>
                                                                                </div> 

                                                                                <div class="card-footer">
                                                                                    <div class="mt-5 text-right">
                                                                                        <button class="btn btn-primary profile-button" type="button" style="font-size: large;" onclick="downloadPieReport()">Download Report</button>
                                                                                    </div>
                                                                                    <br>
                                                                                </div>
                                                                            </div>
                                                                        </div>`;
                    
                    const dateTo = new Date();
                    var yearTo = dateTo.toLocaleString("default", { year: "numeric" });
                    var monthTo = dateTo.toLocaleString("default", { month: "2-digit" });
                    var dayTo = dateTo.toLocaleString("default", { day: "2-digit" });
                    var formattedDateTo = yearTo + "-" + monthTo + "-" + dayTo;
                    document.getElementById("toPie").value = formattedDateTo;

                    const dateFrom = new Date();
                    dateFrom.setTime(dateFrom.getTime() - (30 * 24 * 60 * 60 * 1000));
                    var yearFrom = dateFrom.toLocaleString("default", { year: "numeric" });
                    var monthFrom = dateFrom.toLocaleString("default", { month: "2-digit" });
                    var dayFrom = dateFrom.toLocaleString("default", { day: "2-digit" });
                    var formattedDateFrom = yearFrom + "-" + monthFrom + "-" + dayFrom;
                    document.getElementById("fromPie").value = formattedDateFrom;

                    setPieCharts();
                }
            }

            setPageDetails();
        </script>
    </body>
</html>