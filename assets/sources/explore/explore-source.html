<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
	<link href="../css/bootstrap.min.css" rel="stylesheet">
	<link href="../css/font-awesome.min.css" rel="stylesheet">
	<link href="../css/style.css" rel="stylesheet">
	<link href="../css/responsive.css" rel="stylesheet">
	<link href="alert-style.css" rel="stylesheet">
</head>

<body>
	<div class="container" style="padding-top: 120px;">
		<div class="row">
			<div class="col-sm-3">
				<div class="left-sidebar">
					<div class="brands_products">
						<div class="brands-name">
							<h3 style="padding-bottom: 5px;">Search Products</h3>
							<div class="search_box">
								<input type="text" placeholder="Search">
							</div>
						</div>
					</div>
					
					<div class="brands_products" style="padding-top: 10px;">
						<div class="brands-name">
							<ul class="nav nav-pills nav-stacked">
								<h3 style="padding-bottom: 5px;">Item Type</h3>
								<li>
									<span class="pull-right">(0)</span>
									<input type="checkbox" id="pc1" name="pc1" value="pc1">
									<label for="pc1"> Chair </label><br>
								</li>
								<li>
									<span class="pull-right">(0)</span>
									<input type="checkbox" id="pc2" name="pc2" value="pc2">
									<label for="pc2"> Table  </label><br>
								</li>
								<li>
									<span class="pull-right">(0)</span>
									<input type="checkbox" id="pc3" name="pc3" value="pc3">
									<label for="pc3"> Sofa </label><br>
								</li>
								<li>
									<span class="pull-right">(0)</span>
									<input type="checkbox" id="pc4" name="pc4" value="pc4">
									<label for="pc4"> Cupboard </label><br>
								</li>
								<li>
									<span class="pull-right">(0)</span>
									<input type="checkbox" id="pc5" name="pc5" value="pc5">
									<label for="pc5"> Bed </label><br>
								</li>
								<li>
									<span class="pull-right">(0)</span>
									<input type="checkbox" id="pc6" name="pc6" value="pc6">
									<label for="pc6"> Bench </label><br>
								</li>
								<li>
									<span class="pull-right">(0)</span>
									<input type="checkbox" id="pc6" name="pc6" value="pc6">
									<label for="pc6"> Bookcase </label><br>
								</li> 	
								<li>
									<span class="pull-right">(0)</span>
									<input type="checkbox" id="pc6" name="pc6" value="pc6">
									<label for="pc6"> Desk </label><br>
								</li> 
								<li>
									<span class="pull-right">(0)</span>
									<input type="checkbox" id="pc6" name="pc6" value="pc6">
									<label for="pc6"> Other </label><br>
								</li> 
							</ul>
						</div>
					</div>

					<div class="brands_products" style="padding-top: 10px;">
						<div class="brands-name">
							<ul class="nav nav-pills nav-stacked">
								<h3 style="padding-bottom: 5px;">Price Range</h3>
								<li>
									<span class="pull-right">(0)</span>
									<input type="checkbox" id="pr1" name="pr1" value="pr1">
									<label for="pr1"> Less than LKR 50 K </label><br>
								</li>
								<li>
									<span class="pull-right">(0)</span>
									<input type="checkbox" id="pr2" name="pr2" value="pr2">
									<label for="pr2"> LKR 50 K - LKR 150 K </label><br>
								</li>
								<li>
									<span class="pull-right">(0)</span>
									<input type="checkbox" id="pr3" name="pr3" value="pr3">
									<label for="pr3"> LKR 150 K - LKR 200 K </label><br>
								</li>
								<li>
									<span class="pull-right">(0)</span>
									<input type="checkbox" id="pr4" name="pr4" value="pr4">
									<label for="pr4"> LKR 200 K - LKR 250 K </label><br>
								</li>
								<li>
									<span class="pull-right">(0)</span>
									<input type="checkbox" id="pr5" name="pr5" value="pr5">
									<label for="pr5"> LKR 250 K - LKR 300 K </label><br>
								</li>
								<li>
									<span class="pull-right">(0)</span>
									<input type="checkbox" id="pr6" name="pr6" value="pr6">
									<label for="pr6"> LKR 300 K and higher </label><br>
								</li>
							</ul>
						</div>
					</div>

					<div class="brands_products" style="padding-top: 10px;">
						<div class="brands-name">
							<ul class="nav nav-pills nav-stacked">
								<h3 style="padding-bottom: 5px;">Location</h3>
								<li>
									<span class="pull-right">(0)</span>
									<input type="checkbox" id="pc1" name="pc1" value="pc1">
									<label for="pc1"> Living Room </label><br>
								</li>
								<li>
									<span class="pull-right">(0)</span>
									<input type="checkbox" id="pc2" name="pc2" value="pc2">
									<label for="pc2"> Dining </label><br>
								</li>
								<li>
									<span class="pull-right">(0)</span>
									<input type="checkbox" id="pc3" name="pc3" value="pc3">
									<label for="pc3"> Bedroom </label><br>
								</li>
								<li>
									<span class="pull-right">(0)</span>
									<input type="checkbox" id="pc4" name="pc4" value="pc4">
									<label for="pc4"> Office </label><br>
								</li>
								<li>
									<span class="pull-right">(0)</span>
									<input type="checkbox" id="pc5" name="pc5" value="pc5">
									<label for="pc5"> Outdoor </label><br>
								</li>
								<li>
									<span class="pull-right">(0)</span>
									<input type="checkbox" id="pc6" name="pc6" value="pc6">
									<label for="pc6"> Other </label><br>
								</li>
							</ul>
						</div>
					</div>

					

					<div class="brands_products" style="padding-top: 10px;">
						<div class="brands-name">
							<ul class="nav nav-pills nav-stacked">
								<h3 style="padding-bottom: 5px;">Category</h3>
								<li>
									<span class="pull-right">(0)</span>
									<input type="checkbox" id="pc1" name="pc1" value="pc1">
									<label for="pc1"> Classy </label><br>
								</li>
								<li>
									<span class="pull-right">(0)</span>
									<input type="checkbox" id="pc2" name="pc2" value="pc2">
									<label for="pc2"> Antique </label><br>
								</li>
								<li>
									<span class="pull-right">(0)</span>
									<input type="checkbox" id="pc3" name="pc3" value="pc3">
									<label for="pc3"> Traditional </label><br>
								</li>
								<li>
									<span class="pull-right">(0)</span>
									<input type="checkbox" id="pc4" name="pc4" value="pc4">
									<label for="pc4"> Modern </label><br>
								</li>
								<li>
									<span class="pull-right">(0)</span>
									<input type="checkbox" id="pc5" name="pc5" value="pc5">
									<label for="pc5"> Contemporary </label><br>
								</li>
								<li>
									<span class="pull-right">(0)</span>
									<input type="checkbox" id="pc6" name="pc6" value="pc6">
									<label for="pc6"> Transitional </label><br>
								</li>
								<li>
									<span class="pull-right">(0)</span>
									<input type="checkbox" id="pc6" name="pc6" value="pc6">
									<label for="pc6"> Coastal </label><br>
								</li>
								<li>
									<span class="pull-right">(0)</span>
									<input type="checkbox" id="pc6" name="pc6" value="pc6">
									<label for="pc6"> Minimalist </label><br>
								</li>
							</ul>
						</div>
					</div>

				</div>
			</div>
			
			<div class="col-sm-9 padding-right">
				<div class="features_items" id="products_list_view">

				</div>
			</div>

			<div class="row" align="right" style="padding-right: 20px;">
				<ul class="pagination alg-right-pad">
					<li><a href="#">&laquo;</a></li>
					<li><a href="#">1</a></li>
					<li><a href="#">2</a></li>
					<li><a href="#">3</a></li>
					<li><a href="#">4</a></li>
					<li><a href="#">5</a></li>
					<li><a href="#">&raquo;</a></li>
				</ul>
			</div>
		</div>
	</div>


	<div class="toast" style="position: absolute;"> </div>

	<script src="../../framework/bootstrap/js/bootstrap.bundle.min.js"></script>
	<script src="../../alert-box/alert-script.js"></script>
    <script src="../js/script.js"></script>
		
	<script>
		// Arrays to store searched product details
		var arrSellerIds = [];
		var arrItemIds = [];
		var arrTotalSoldCounts = [];
		arrSellerIds.length = 0;
		arrItemIds.length = 0;
		arrTotalSoldCounts.length = 0;


		// Display products stored in (arrSellerIds + arrItemIds) arrays
		const setProducts = async() => {
			let response = await fetch("http://localhost:8080/getAllProducts");
			let products = await response.json();

			var productList = "";


			for(let j = 0; j < arrSellerIds.length; j++){
				for(let i = 0; i < products.length; i++){
					if(arrSellerIds[j] == products[i].userId && arrItemIds[j] == products[i].itemId){
						productList += `<div class="col-sm-4"> <div class="product-image-wrapper"> <div class="single-products"> <div class="productinfo text-center"> <img src="${products[i].clr1Img}" alt="" /> <h2>LKR ${(products[i].price).toLocaleString('en-US')}</h2> <p>${products[i].itemName}</p> <a href="" class="btn btn-default add-to-cart" onclick="openItemView(${products[i].userId}, ${products[i].itemId})">View Details</a></div></div><div class="choose"><ul class="nav nav-pills nav-justified"><li><a href="#" onclick="addToCart(${products[i].userId}, ${products[i].itemId})">Add to Cart</a></li><li><a href="#" onclick="addToWishlist(${products[i].userId}, ${products[i].itemId})">Add to Wishlist</a></li></ul></div></div></div>`;
						break;
					}
				}
			}
			

			document.getElementById("products_list_view").innerHTML = productList;
		}


		// All products added to the product details arrays in trending order - When page is loaded
		const setAllProducts = async() => {
			let response3 = await fetch("http://localhost:8080/getAllProducts");
			let products3 = await response3.json();

			arrSellerIds.length = products3.length;
			arrItemIds.length = products3.length;
			arrTotalSoldCounts.length = products3.length;


			for(let i = 0; i < products3.length; i++){
				arrSellerIds[i] = products3[i].userId;
				arrItemIds[i] = products3[i].itemId;
				arrTotalSoldCounts[i] = products3[i].totalSold;
			}

			
			// Sort based on total sales
			for(let i = 0; i < products3.length; i++){
				for(let j = 0; j < (products3.length - i -1); j++){
					if(arrTotalSoldCounts[j] < arrTotalSoldCounts[j+1]){
						var temp1 = arrTotalSoldCounts[j];
						arrTotalSoldCounts[j] = arrTotalSoldCounts[j+1];
						arrTotalSoldCounts[j+1] = temp1;
						
						var temp2 = arrSellerIds[j];
						arrSellerIds[j] = arrSellerIds[j+1];
						arrSellerIds[j+1] = temp2;

						var temp3 = arrItemIds[j];
						arrItemIds[j] = arrItemIds[j+1];
						arrItemIds[j+1] = temp3;
					}
				}
			}


			// Display products in the page
			setProducts();
		}

		setAllProducts();


		// Buyer id
		var buyerId = localStorage.getItem("id");


		// View selected item details
		const openItemView = async(userId, itemId) =>{
			localStorage.setItem("sellerId", userId);
			localStorage.setItem("productId", itemId);
			open("../../../item-demo.html", "_parent");
		}


		// Add selected item to cart
		const addToCart = async(sellerID, itemID) => {
			if(buyerId == null){
				open("../../../../sign-in.html", "_blank");
			}else if(buyerId == sellerID){
				errorToast("This is a product added by you. Please note that you can't add your own products to cart.");
			}else{
				let response1 = await fetch(`http://localhost:8080/findUserProducts/${sellerID}`);
				let items = await response1.json();
				
				var stock = 0;
				
				for (let i = 0; i < items.length; i++) {
					if(items[i].itemId == itemID){
						stock = items[i].stockClr1 + items[i].stockClr2 + items[i].stockClr3;
						break;
					}
				}

				if(stock <= 0){
					errorToast("Item out of stock!");
				}else{
					var available = false;

					let response2 = await fetch(`http://localhost:8080/findCartItems/${buyerId}`);
					let cartItems = await response2.json();

					for (let i = 0; i < cartItems.length; i++) {
						if(cartItems[i].sellerID == sellerID & cartItems[i].productID == itemID){
							available = true;
							break;
						}
					}

					if(available == true){
						errorToast("Iteam already added to cart!");
					}else{
						var object2 = {};
						object2["id"] = buyerId;
						object2["sellerID"] = sellerID;
						object2["productID"] = itemID;

						var jsonText2 = JSON.stringify(object2);
						
						await fetch("http://localhost:8080/addItemToCart", {
							method: "POST",
							headers: {
								'Accept': 'application/json',
								'Content-Type': 'application/json'
							},
							body: jsonText2
						})
						.then(response => response.text())
						.then(infoToast("Item added to your cart!"))
						.catch(error => console.log('Authorization failed: ' + error.message));	
					}					
				}
			}
		}


		// Add selected item to wishlist
		const addToWishlist = async(sellerID, itemID) => {
			if(buyerId == null){
				open("../../../../sign-in.html", "_blank");
			}else if(buyerId == sellerID){
				errorToast("This is a product added by you. Please note that you can't add your own products to wishlist.");
			}else{
				var available = false;

				let response2 = await fetch(`http://localhost:8080/findWishlistItems/${buyerId}`);
				let wishlistItems = await response2.json();

				for (let i = 0; i < wishlistItems.length; i++) {
					if(wishlistItems[i].sellerID == sellerID & wishlistItems[i].productID == itemID){
						available = true;
						break;
					}
				}

				if(available == true){
					errorToast("Iteam already added to wishlist!");
				}else{
					var object2 = {};
					object2["id"] = buyerId;
					object2["sellerID"] = sellerID;
					object2["productID"] = itemID;

					var jsonText2 = JSON.stringify(object2);
					
					await fetch("http://localhost:8080/addItemToWishlist", {
						method: "POST",
						headers: {
							'Accept': 'application/json',
							'Content-Type': 'application/json'
						},
						body: jsonText2
					})
					.then(response => response.text())
					.then(infoToast("Item added to your wishlist!"))
					.catch(error => console.log('Authorization failed: ' + error.message));
				}
			}
		}
		
	</script>
</body>
</html>