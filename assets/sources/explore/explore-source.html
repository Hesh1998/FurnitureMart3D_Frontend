<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
	<link href="../css/bootstrap.min.css" rel="stylesheet">
	<link href="../css/font-awesome.min.css" rel="stylesheet">
	<link href="../css/style.css" rel="stylesheet">
	<link href="../css/responsive.css" rel="stylesheet">
	<link href="alert-style.css" rel="stylesheet">
</head>

<body>
	<div class="container" style="padding-top: 120px;">
		<div class="row">
			<div class="col-sm-3">
				<div class="left-sidebar">
					<div class="brands_products">
						<div class="brands-name">
							<h3 style="padding-bottom: 5px;">Search Products</h3>
							<div class="search_box">
								<input id="searchText" type="text" placeholder="Search" style="font-weight: 500; color: #696763;">
							</div>
						</div>
					</div>
					
					<div class="brands_products" style="padding-top: 10px;">
						<div class="brands-name">
							<ul class="nav nav-pills nav-stacked">
								<h3 style="padding-bottom: 5px;">Item Type</h3>
								<li>
									<input type="checkbox" id="chair" value="chair" onclick="FilterProducts()">
									<label for="chair"> Chair </label><br>
								</li>
								<li>
									<input type="checkbox" id="table" value="table" onclick="FilterProducts()">
									<label for="table"> Table  </label><br>
								</li>
								<li>
									<input type="checkbox" id="sofa" value="sofa" onclick="FilterProducts()">
									<label for="sofa"> Sofa </label><br>
								</li>
								<li>
									<input type="checkbox" id="cupboard" value="cupboard" onclick="FilterProducts()">
									<label for="cupboard"> Cupboard </label><br>
								</li>
								<li>
									<input type="checkbox" id="bed" value="bed" onclick="FilterProducts()">
									<label for="bed"> Bed </label><br>
								</li>
								<li>
									<input type="checkbox" id="bench" value="bench" onclick="FilterProducts()">
									<label for="bench"> Bench </label><br>
								</li>
								<li>
									<input type="checkbox" id="bookcase" value="bookcase" onclick="FilterProducts()">
									<label for="bookcase"> Bookcase </label><br>
								</li> 	
								<li>
									<input type="checkbox" id="desk" value="desk" onclick="FilterProducts()">
									<label for="desk"> Desk </label><br>
								</li> 
								<li>
									<input type="checkbox" id="other" value="other" onclick="FilterProducts()">
									<label for="other"> Other </label><br>
								</li> 
							</ul>
						</div>
					</div>

					<div class="brands_products" style="padding-top: 10px;">
						<div class="brands-name">
							<ul class="nav nav-pills nav-stacked">
								<h3 style="padding-bottom: 5px;">Price Range</h3>
								<li>
									<input type="checkbox" id="pr1" value="pr1">
									<label for="pr1"> Less than LKR 50 K </label><br>
								</li>
								<li>
									<input type="checkbox" id="pr2" value="pr2">
									<label for="pr2"> LKR 50 K - LKR 150 K </label><br>
								</li>
								<li>
									<input type="checkbox" id="pr3" value="pr3">
									<label for="pr3"> LKR 150 K - LKR 200 K </label><br>
								</li>
								<li>
									<input type="checkbox" id="pr4" value="pr4">
									<label for="pr4"> LKR 200 K - LKR 250 K </label><br>
								</li>
								<li>
									<input type="checkbox" id="pr5" value="pr5">
									<label for="pr5"> LKR 250 K - LKR 300 K </label><br>
								</li>
								<li>
									<input type="checkbox" id="pr6" value="pr6">
									<label for="pr6"> LKR 300 K and higher </label><br>
								</li>
							</ul>
						</div>
					</div>

					<div class="brands_products" style="padding-top: 10px;">
						<div class="brands-name">
							<ul class="nav nav-pills nav-stacked">
								<h3 style="padding-bottom: 5px;">Location</h3>
								<li>
									<input type="checkbox" id="living" value="living">
									<label for="living"> Living Room </label><br>
								</li>
								<li>
									<input type="checkbox" id="dining" value="dining">
									<label for="dining"> Dining </label><br>
								</li>
								<li>
									<input type="checkbox" id="bedroom" value="bedroom">
									<label for="bedroom"> Bedroom </label><br>
								</li>
								<li>
									<input type="checkbox" id="office" value="office">
									<label for="office"> Office </label><br>
								</li>
								<li>
									<input type="checkbox" id="outdoor" value="outdoor">
									<label for="outdoor"> Outdoor </label><br>
								</li>
								<li>
									<input type="checkbox" id="other" value="other">
									<label for="other"> Other </label><br>
								</li>
							</ul>
						</div>
					</div>

					

					<div class="brands_products" style="padding-top: 10px;">
						<div class="brands-name">
							<ul class="nav nav-pills nav-stacked">
								<h3 style="padding-bottom: 5px;">Category</h3>
								<li>
									<input type="checkbox" id="classy" value="classy">
									<label for="classy"> Classy </label><br>
								</li>
								<li>
									<input type="checkbox" id="antique" value="antique">
									<label for="antique"> Antique </label><br>
								</li>
								<li>
									<input type="checkbox" id="traditional" value="traditional">
									<label for="traditional"> Traditional </label><br>
								</li>
								<li>
									<input type="checkbox" id="modern" value="modern">
									<label for="modern"> Modern </label><br>
								</li>
								<li>
									<input type="checkbox" id="contemporary" value="contemporary">
									<label for="contemporary"> Contemporary </label><br>
								</li>
								<li>
									<input type="checkbox" id="transitional" value="transitional">
									<label for="transitional"> Transitional </label><br>
								</li>
								<li>
									<input type="checkbox" id="coastal" value="coastal">
									<label for="coastal"> Coastal </label><br>
								</li>
								<li>
									<input type="checkbox" id="minimalist" value="minimalist">
									<label for="minimalist"> Minimalist </label><br>
								</li>
							</ul>
						</div>
					</div>

				</div>
			</div>
			
			<div class="col-sm-9 padding-right">
				<div class="features_items" id="products_list_view">

				</div>
			</div>

		</div>
	</div>


	<div class="toast" style="position: absolute;"> </div>

	<script src="../../framework/bootstrap/js/bootstrap.bundle.min.js"></script>
	<script src="../../alert-box/alert-script.js"></script>
    <script src="../js/script.js"></script>
		

	<script>
		// Arrays to store searched product details
		var arrSellerIds = [];
		var arrItemIds = [];
		var arrTotalSoldCounts = [];
		arrSellerIds.length = 0;
		arrItemIds.length = 0;
		arrTotalSoldCounts.length = 0;


		// Display products stored in (arrSellerIds + arrItemIds) arrays
		const setProducts = async() => {
			let response = await fetch("http://localhost:8080/getAllProducts");
			let products = await response.json();

			var productList = "";


			for(let j = 0; j < arrSellerIds.length; j++){
				for(let i = 0; i < products.length; i++){
					if(arrSellerIds[j] == products[i].userId && arrItemIds[j] == products[i].itemId){
						productList += `<div class="col-sm-4"> <div class="product-image-wrapper"> <div class="single-products"> <div class="productinfo text-center"> <img src="${products[i].clr1Img}" alt="" /> <h2>LKR ${(products[i].price).toLocaleString('en-US')}</h2> <p>${products[i].itemName}</p> <a href="" class="btn btn-default add-to-cart" onclick="openItemView(${products[i].userId}, ${products[i].itemId})">View Details</a></div></div><div class="choose"><ul class="nav nav-pills nav-justified"><li><a href="#" onclick="addToCart(${products[i].userId}, ${products[i].itemId})">Add to Cart</a></li><li><a href="#" onclick="addToWishlist(${products[i].userId}, ${products[i].itemId})">Add to Wishlist</a></li></ul></div></div></div>`;
						break;
					}
				}
			}
			

			document.getElementById("products_list_view").innerHTML = productList;
		}


		// All products added to the product details arrays in trending order - When page is loaded
		const setAllProducts = async() => {
			let response3 = await fetch("http://localhost:8080/getAllProducts");
			let products3 = await response3.json();

			arrSellerIds = [];
			arrItemIds = [];
			arrTotalSoldCounts = [];
			arrSellerIds.length = 0;
			arrItemIds.length = 0;
			arrTotalSoldCounts.length = 0;

			arrSellerIds.length = products3.length;
			arrItemIds.length = products3.length;
			arrTotalSoldCounts.length = products3.length;


			for(let i = 0; i < products3.length; i++){
				arrSellerIds[i] = products3[i].userId;
				arrItemIds[i] = products3[i].itemId;
				arrTotalSoldCounts[i] = products3[i].totalSold;
			}

			
			// Sort based on total sales
			for(let i = 0; i < products3.length; i++){
				for(let j = 0; j < (products3.length - i -1); j++){
					if(arrTotalSoldCounts[j] < arrTotalSoldCounts[j+1]){
						var temp1 = arrTotalSoldCounts[j];
						arrTotalSoldCounts[j] = arrTotalSoldCounts[j+1];
						arrTotalSoldCounts[j+1] = temp1;
						
						var temp2 = arrSellerIds[j];
						arrSellerIds[j] = arrSellerIds[j+1];
						arrSellerIds[j+1] = temp2;

						var temp3 = arrItemIds[j];
						arrItemIds[j] = arrItemIds[j+1];
						arrItemIds[j+1] = temp3;
					}
				}
			}


			// Display products in the page
			setProducts();
		}

		setAllProducts();


		// Searched products added to the product details arrays in trending order
		const setSearchedProducts = async() => {
			arrSellerIds = [];
			arrItemIds = [];
			arrTotalSoldCounts = [];
			arrSellerIds.length = 0;
			arrItemIds.length = 0;
			arrTotalSoldCounts.length = 0;	


			if(searchText = ""){
				setAllProducts();
			}else{
				let response4 = await fetch("http://localhost:8080/getAllProducts");
				let products4 = await response4.json();

				var k = 0;

				for(let i = 0; i < products4.length; i++){
					if(((products4[i].itemName).toLowerCase()).includes((document.getElementById("searchText").value).toLowerCase()) || ((products4[i].description).toLowerCase()).includes((document.getElementById("searchText").value).toLowerCase())){
						arrSellerIds.length = arrSellerIds.length + 1;
						arrItemIds.length = arrItemIds.length + 1;
						arrTotalSoldCounts.length = arrTotalSoldCounts.length + 1;	

						arrSellerIds[k] = products4[i].userId;
						arrItemIds[k] = products4[i].itemId;
						arrTotalSoldCounts[k] = products4[i].totalSold;

						k++;
					}
				}


				// Sort based on total sales
				for(let i = 0; i < arrSellerIds.length; i++){
					for(let j = 0; j < (arrSellerIds.length - i -1); j++){
						if(arrTotalSoldCounts[j] < arrTotalSoldCounts[j+1]){
							var temp1 = arrTotalSoldCounts[j];
							arrTotalSoldCounts[j] = arrTotalSoldCounts[j+1];
							arrTotalSoldCounts[j+1] = temp1;
							
							var temp2 = arrSellerIds[j];
							arrSellerIds[j] = arrSellerIds[j+1];
							arrSellerIds[j+1] = temp2;

							var temp3 = arrItemIds[j];
							arrItemIds[j] = arrItemIds[j+1];
							arrItemIds[j+1] = temp3;
						}
					}
				}


				// Display products in the page
				setProducts();
			}

		}


		// Enter button pressed when searching
		var inputText = document.getElementById("searchText");
		inputText.addEventListener("keypress", function(event) {
			if (event.key === "Enter") {
				event.preventDefault();
				setSearchedProducts();
			}
		});


		// Filter products - All products or for a specific search
		const FilterProducts = async() => {
			var arrYesNo = [];
			arrYesNo.length = 0;

			arrYesNo.length = arrSellerIds.length;

			for(let i = 0; i < arrYesNo.length; i++){
				arrYesNo[i] = "N";
			}

			console.log(arrYesNo);
		}



		// Buyer id
		var buyerId = localStorage.getItem("id");


		// View selected item details
		const openItemView = async(userId, itemId) =>{
			localStorage.setItem("sellerId", userId);
			localStorage.setItem("productId", itemId);
			open("../../../item-demo.html", "_parent");
		}


		// Add selected item to cart
		const addToCart = async(sellerID, itemID) => {
			if(buyerId == null){
				open("../../../../sign-in.html", "_blank");
			}else if(buyerId == sellerID){
				errorToast("This is a product added by you. Please note that you can't add your own products to cart.");
			}else{
				let response1 = await fetch(`http://localhost:8080/findUserProducts/${sellerID}`);
				let items = await response1.json();
				
				var stock = 0;
				
				for (let i = 0; i < items.length; i++) {
					if(items[i].itemId == itemID){
						stock = items[i].stockClr1 + items[i].stockClr2 + items[i].stockClr3;
						break;
					}
				}

				if(stock <= 0){
					errorToast("Item out of stock!");
				}else{
					var available = false;

					let response2 = await fetch(`http://localhost:8080/findCartItems/${buyerId}`);
					let cartItems = await response2.json();

					for (let i = 0; i < cartItems.length; i++) {
						if(cartItems[i].sellerID == sellerID & cartItems[i].productID == itemID){
							available = true;
							break;
						}
					}

					if(available == true){
						errorToast("Iteam already added to cart!");
					}else{
						var object2 = {};
						object2["id"] = buyerId;
						object2["sellerID"] = sellerID;
						object2["productID"] = itemID;

						var jsonText2 = JSON.stringify(object2);
						
						await fetch("http://localhost:8080/addItemToCart", {
							method: "POST",
							headers: {
								'Accept': 'application/json',
								'Content-Type': 'application/json'
							},
							body: jsonText2
						})
						.then(response => response.text())
						.then(infoToast("Item added to your cart!"))
						.catch(error => console.log('Authorization failed: ' + error.message));	
					}					
				}
			}
		}


		// Add selected item to wishlist
		const addToWishlist = async(sellerID, itemID) => {
			if(buyerId == null){
				open("../../../../sign-in.html", "_blank");
			}else if(buyerId == sellerID){
				errorToast("This is a product added by you. Please note that you can't add your own products to wishlist.");
			}else{
				var available = false;

				let response2 = await fetch(`http://localhost:8080/findWishlistItems/${buyerId}`);
				let wishlistItems = await response2.json();

				for (let i = 0; i < wishlistItems.length; i++) {
					if(wishlistItems[i].sellerID == sellerID & wishlistItems[i].productID == itemID){
						available = true;
						break;
					}
				}

				if(available == true){
					errorToast("Iteam already added to wishlist!");
				}else{
					var object2 = {};
					object2["id"] = buyerId;
					object2["sellerID"] = sellerID;
					object2["productID"] = itemID;

					var jsonText2 = JSON.stringify(object2);
					
					await fetch("http://localhost:8080/addItemToWishlist", {
						method: "POST",
						headers: {
							'Accept': 'application/json',
							'Content-Type': 'application/json'
						},
						body: jsonText2
					})
					.then(response => response.text())
					.then(infoToast("Item added to your wishlist!"))
					.catch(error => console.log('Authorization failed: ' + error.message));
				}
			}
		}
		
	</script>
</body>
</html>